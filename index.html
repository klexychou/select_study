<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>ÊäΩÊäΩÊ®Ç V9.3</title>
    
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="theme-color" content="#121212">
    <link rel="apple-touch-icon" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100' style='background-color: %232c3e50'%3E%3Crect width='100' height='100' fill='%232c3e50'/%3E%3Ctext y='50%25' x='50%25' dominant-baseline='central' text-anchor='middle' font-size='60' %3Eüìö%3C/text%3E%3C/svg%3E">

    <style>
        :root { --list-font-size: 16px; --theme-color: #3498db; }
        body {
            font-family: "Microsoft JhengHei", -apple-system, BlinkMacSystemFont, sans-serif;
            background-color: #121212; color: #ffffff; margin: 0;
            height: 100dvh; overflow: hidden; display: flex; flex-direction: column;
            padding-top: env(safe-area-inset-top); padding-bottom: 0; user-select: none;
        }
        .hidden { display: none !important; }
        button { border: none; border-radius: 12px; font-weight: bold; cursor: pointer; transition: transform 0.1s; -webkit-tap-highlight-color: transparent; outline: none; }
        button:active { transform: scale(0.92); }
        
        #confetti-canvas { position: fixed; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; z-index: 999; }

        .header-nav {
            flex-shrink: 0; padding: 10px 15px; display: flex; justify-content: space-between; align-items: center;
            background: #1e1e1e; border-bottom: 1px solid #333; min-height: 45px; z-index: 10;
        }
        h2 { margin: 0; color: #3498db; font-size: 18px; }
        .icon-btn { background: #333; color: #ddd; font-size: 14px; padding: 6px 10px; border-radius: 8px; margin-left: 8px; }
        .icon-btn.active { background: #3498db; color: white; }

        #setup-screen { flex: 1; display: flex; flex-direction: column; overflow: hidden; }
        .controls-wrapper { flex-shrink: 0; padding: 8px 15px; background: #121212; }
        .control-bar { background-color: #252525; padding: 10px 15px; border-radius: 10px; border: 1px solid #333; }
        .control-row { display: flex; align-items: center; justify-content: space-between; }
        
        .switch-container { position: relative; display: inline-block; width: 40px; height: 24px; }
        .switch-container input { opacity: 0; width: 0; height: 0; }
        .slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: #555; transition: .4s; border-radius: 34px; }
        .slider:before { position: absolute; content: ""; height: 18px; width: 18px; left: 3px; bottom: 3px; background-color: white; transition: .4s; border-radius: 50%; }
        input:checked + .slider { background-color: #e67e22; }
        input:checked + .slider:before { transform: translateX(16px); }

        .list-container { flex: 1; overflow-y: auto; padding: 0 15px; min-height: 0; padding-bottom: 20px; }
        .subject-row {
            display: flex; align-items: center; background-color: #1e1e1e; margin-bottom: 4px; padding: 4px 10px;
            border-radius: 8px; border: 1px solid #333; width: 100%; box-sizing: border-box; 
        }
        
        .color-dot {
            width: 20px; height: 20px; border-radius: 50%; margin-right: 12px; cursor: pointer; flex-shrink: 0; border: 2px solid #333;
        }
        
        input[type="checkbox"].sub-check { flex-shrink: 0; transform: scale(1.1); margin-right: 8px; accent-color: #3498db; }
        .name-input {
            flex: 1; width: 0; min-width: 50px; font-size: var(--list-font-size); font-weight: 500;
            background: transparent; border: none; color: white; border-bottom: 1px solid transparent; padding: 2px 0; margin-right: 6px; border-radius: 0;
        }
        .name-input:focus { border-bottom: 1px solid #3498db; outline: none; background: #252525; }
        .weight-input {
            flex-shrink: 0; width: 32px; height: 26px; text-align: center; font-size: 14px;
            background-color: #2c3e50; color: #fff; border: 1px solid #444; border-radius: 5px; margin-right: 6px;
        }
        .order-btn-group { flex-shrink: 0; display: flex; flex-direction: column; gap: 1px; width: 22px; }
        .order-btn { background: #333; color: #aaa; border-radius: 3px; padding: 0; font-size: 8px; height: 12px; line-height: 12px; width: 100%; }

        .bottom-action-area {
            flex-shrink: 0; background: #121212; display: flex; gap: 12px; align-items: stretch;
            padding: 10px 15px calc(40px + env(safe-area-inset-bottom)) 15px;
            border-top: 1px solid #222; z-index: 100; position: relative;
        }
        .font-btn { flex-shrink: 0; width: 50px; background-color: #252525; color: #ccc; border: 1px solid #333; font-family: serif; display: flex; align-items: center; justify-content: center; border-radius: 12px; }
        .start-btn { flex: 1; padding: 12px; background: linear-gradient(135deg, #2ecc71, #27ae60); color: white; font-size: 18px; border-radius: 12px; box-shadow: 0 4px 10px rgba(46, 204, 113, 0.4); white-space: nowrap; }

        /* --- ÊäΩÁ±§ËàáË®àÊôÇÈ†ÅÈù¢ --- */
        #draw-screen { flex: 1; display: flex; flex-direction: column; align-items: center; justify-content: center; position: relative; z-index: 10;}
        #deck-status { position: absolute; top: 30px; right: 20px; background: #e67e22; padding: 6px 12px; border-radius: 20px; font-size: 14px; font-weight: bold; color: white; }
        
        #result-display { font-size: 56px; font-weight: 800; color: #3498db; margin-bottom: 20px; text-align: center; padding: 0 20px; line-height: 1.2; text-shadow: 0 0 30px rgba(255,255,255,0.1); }
        
        #draw-btn-container { margin-bottom: 30px; }
        .draw-action-btn { 
            padding: 20px 80px; font-size: 28px; 
            background: linear-gradient(135deg, #3498db, #2980b9); 
            color: white; border-radius: 50px; 
            box-shadow: 0 10px 25px rgba(52, 152, 219, 0.4);
            animation: pulse 2s infinite;
        }
        @keyframes pulse {
            0% { transform: scale(1); box-shadow: 0 0 0 0 rgba(52, 152, 219, 0.7); }
            70% { transform: scale(1.05); box-shadow: 0 0 0 15px rgba(52, 152, 219, 0); }
            100% { transform: scale(1); box-shadow: 0 0 0 0 rgba(52, 152, 219, 0); }
        }

        .timer-container {
            background: #252525; padding: 20px; border-radius: 20px; text-align: center; border: 1px solid #444; margin-bottom: 30px; width: 260px;
        }
        .timer-adjust-row { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; }
        .adj-btn { width: 36px; height: 36px; border-radius: 50%; background: #444; color: white; font-size: 18px; display: flex; align-items: center; justify-content: center; }
        .adj-btn:active { background: #666; }
        #timer-display { font-size: 48px; font-family: monospace; font-weight: bold; color: #fff; letter-spacing: 2px; }
        .timer-controls { display: flex; justify-content: center; gap: 10px; margin-top: 15px;}
        .timer-btn { padding: 10px 20px; border-radius: 10px; font-size: 16px; font-weight: bold; flex: 1;}
        .t-start { background: #27ae60; color: white; }
        .t-reset { background: #c0392b; color: white; }

        .back-btn { background: transparent; color: #7f8c8d; font-size: 14px; padding: 10px 20px; margin-top: 10px; }

        /* --- ÁÜ±ÂäõÂúñ (V9.3 Êñ∞Áâà) --- */
        #stats-screen { flex: 1; display: flex; flex-direction: column; background: #121212; z-index: 10;}
        
        /* ÊîæÂú®ÁÜ±ÂäõÂúñÈ†ÅÈù¢ÁöÑÁõÆÊ®ôË®≠ÂÆöÂàó */
        .stats-control-bar {
            flex-shrink: 0; padding: 10px 20px; background: #1e1e1e; border-bottom: 1px solid #333;
            display: flex; align-items: center; justify-content: space-between;
        }
        .goal-label { font-size: 12px; color: #aaa; }
        .goal-input {
            width: 50px; background: #333; border: 1px solid #555; color: white; text-align: center; border-radius: 6px; padding: 4px; font-size: 14px; margin-left: 10px;
        }

        .heatmap-container { flex: 1; padding: 10px 15px; overflow-y: auto; } /* Ê∏õÂ∞ë padding Â¢ûÂä†Á©∫Èñì */
        .heatmap-grid { display: grid; grid-template-columns: auto repeat(7, 1fr); gap: 2px; align-items: center; } /* Á∏ÆÂ∞è gap */
        
        /* Á∏ÆÂ∞èÂæåÁöÑÊ†ºÂ≠ê */
        .hm-cell { width: 100%; aspect-ratio: 1; border-radius: 3px; background-color: #252525; transition: all 0.3s; }
        .hm-label-col { font-size: 11px; color: #ccc; text-align: right; padding-right: 8px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; max-width: 70px; }
        
    </style>
</head>
<body>

    <canvas id="confetti-canvas"></canvas>

    <div id="setup-screen">
        <div class="header-nav">
            <button id="sound-btn" class="icon-btn active" onclick="toggleSound()">üîä</button>
            <h2>ËÆÄÊõ∏ÊäΩÊäΩÊ®Ç V9.3</h2>
            <button class="icon-btn" onclick="showStats()">üî• ÁÜ±ÂäõÂúñ</button>
        </div>
        
        <div class="controls-wrapper">
            <div class="control-bar">
                <div class="control-row">
                    <div>
                        <div style="font-weight:bold; color:#ddd; font-size:14px;">‰∏çÈáçË§áÊ®°Âºè</div>
                        <div style="font-size:10px; color:#aaa;">ËÆÄÂÆå‰∏ÄÁßëÂ∞ë‰∏ÄÁßë</div>
                    </div>
                    <label class="switch-container">
                        <input type="checkbox" id="deck-mode-toggle" onchange="playTone(800, 0.05, 'triangle')">
                        <span class="slider"></span>
                    </label>
                </div>
            </div>
        </div>
        
        <div class="list-container" id="subject-list"></div>

        <div class="bottom-action-area">
            <button class="font-btn" onclick="adjustFontSize(-1)" style="font-weight: 300; font-size: 18px;">a</button>
            <button class="start-btn" onclick="startSession()">üöÄ ÈñãÂßãÂü∑Ë°å</button>
            <button class="font-btn" onclick="adjustFontSize(1)" style="font-weight: 900; font-size: 20px;">A</button>
        </div>
    </div>

    <div id="draw-screen" class="hidden">
        <div id="deck-status" class="hidden"></div>
        <div id="result-display">?</div>
        
        <div id="draw-btn-container">
            <button id="draw-btn" class="draw-action-btn" onclick="draw()">üé≤ ÊäΩÈÅ∏</button>
        </div>

        <div class="timer-container hidden" id="timer-box">
            <div class="timer-adjust-row">
                <button class="adj-btn" onclick="adjustTimerSetting(-5)">‚àí</button>
                <div id="timer-display">25:00</div>
                <button class="adj-btn" onclick="adjustTimerSetting(5)">+</button>
            </div>
            <div style="font-size:12px; color:#aaa; margin-bottom:5px;">ÂñÆ‰Ωç: 5ÂàÜÈêò</div>
            <div class="timer-controls">
                <button class="timer-btn t-start" onclick="toggleTimer()" id="timer-toggle-btn">‚ñ∂ ÈñãÂßãË®àÊôÇ</button>
                <button class="timer-btn t-reset" onclick="resetTimer()">‚Ü∫ ÈáçÁΩÆ</button>
            </div>
        </div>

        <button class="back-btn" onclick="goBack()">‚Üê ÊîæÊ£Ñ / ËøîÂõûË®≠ÂÆö</button>
    </div>

    <div id="stats-screen" class="hidden">
        <div class="header-nav">
            <h2>ËÆÄÊõ∏ÊôÇÊï∏ÁÜ±ÂäõÂúñ</h2>
            <button class="icon-btn" onclick="closeStats()">‚úï</button>
        </div>
        
        <div class="stats-control-bar">
            <span class="goal-label">ÊØèÊó•ÁõÆÊ®ôÂàÜÈêòÊï∏ (100%‰∫ÆÂ∫¶)</span>
            <input type="number" class="goal-input" id="daily-goal-input" value="120" onchange="updateDailyGoal(this.value)">
        </div>

        <div style="display:grid; grid-template-columns: auto repeat(7, 1fr); gap:2px; padding:10px 15px 0 15px; font-size:10px; color:#666; text-align:center;">
            <div style="width:70px;"></div> <div id="date-headers" style="display:contents;"></div>
        </div>
        <div class="heatmap-container">
            <div id="heatmap-grid" class="heatmap-grid"></div>
        </div>
        <div style="text-align:center; padding:10px;">
            <button onclick="clearHistory()" style="color:#e74c3c; background:none; border:1px solid #e74c3c; padding:6px 20px; border-radius:20px; font-size:12px;">Ê∏ÖÈô§Á¥ÄÈåÑ</button>
        </div>
    </div>

    <script>
        const colorPalette = ['#e74c3c', '#e67e22', '#f1c40f', '#2ecc71', '#3498db', '#9b59b6', '#95a5a6', '#34495e'];
        function getNextColor(currColor) {
            const idx = colorPalette.indexOf(currColor);
            if(idx === -1) return colorPalette[0];
            return colorPalette[(idx + 1) % colorPalette.length];
        }

        // --- 1. JS ÂäüËÉΩÂçÄ ---
        let currentFontSize = 16;
        let dailyGoal = 120; 

        function adjustFontSize(delta) {
            playTone(800, 0.05, 'triangle');
            currentFontSize += delta;
            if (currentFontSize < 12) currentFontSize = 12;
            if (currentFontSize > 24) currentFontSize = 24;
            document.documentElement.style.setProperty('--list-font-size', currentFontSize + 'px');
            localStorage.setItem('studyApp_fontSize', currentFontSize);
        }

        function updateDailyGoal(val) {
            let v = parseInt(val);
            if(isNaN(v) || v < 10) v = 10;
            dailyGoal = v;
            document.getElementById('daily-goal-input').value = v;
            localStorage.setItem('studyApp_dailyGoal', v);
            renderHeatmap(); // Á´ãÂç≥Âà∑Êñ∞
        }

        // --- 2. Áï™ËåÑÈêòÈÇèËºØ ---
        let timerInterval = null;
        let defaultDuration = 25; 
        let timerSeconds = 25 * 60;
        let isTimerRunning = false;
        let timerEndTime = null;
        let currentSubject = null; 

        function adjustTimerSetting(delta) {
            if(isTimerRunning) return;
            playTone(800, 0.05, 'triangle');
            defaultDuration += delta;
            if(defaultDuration < 5) defaultDuration = 5;
            if(defaultDuration > 120) defaultDuration = 120;
            
            timerSeconds = defaultDuration * 60;
            updateTimerDisplay();
            localStorage.setItem('studyApp_timerPref', defaultDuration);
        }

        function updateTimerDisplay() {
            const m = Math.floor(timerSeconds / 60).toString().padStart(2, '0');
            const s = (timerSeconds % 60).toString().padStart(2, '0');
            document.getElementById('timer-display').innerText = `${m}:${s}`;
        }

        function toggleTimer() {
            playTone(800, 0.05, 'triangle');
            const btn = document.getElementById('timer-toggle-btn');
            
            if (isTimerRunning) {
                clearInterval(timerInterval);
                isTimerRunning = false;
                btn.innerText = "‚ñ∂ ÁπºÁ∫å";
                btn.style.background = "#27ae60";
            } else {
                if ("Notification" in window && Notification.permission !== "granted") Notification.requestPermission();
                
                timerEndTime = Date.now() + timerSeconds * 1000;
                isTimerRunning = true;
                btn.innerText = "‚è∏ Êö´ÂÅú";
                btn.style.background = "#f39c12";

                timerInterval = setInterval(() => {
                    const now = Date.now();
                    const remaining = Math.ceil((timerEndTime - now) / 1000);
                    if (remaining <= 0) {
                        timerSeconds = 0;
                        updateTimerDisplay();
                        timerFinished();
                    } else {
                        timerSeconds = remaining;
                        updateTimerDisplay();
                    }
                }, 1000);
            }
        }

        function resetTimer() {
            playTone(800, 0.05, 'triangle');
            clearInterval(timerInterval);
            isTimerRunning = false;
            timerSeconds = defaultDuration * 60;
            updateTimerDisplay();
            const btn = document.getElementById('timer-toggle-btn');
            btn.innerText = "‚ñ∂ ÈñãÂßãË®àÊôÇ";
            btn.style.background = "#27ae60";
        }

        function timerFinished() {
            clearInterval(timerInterval);
            isTimerRunning = false;
            playCheer();
            if(currentSubject) recordHistory(currentSubject.name, defaultDuration);
            if ("Notification" in window && Notification.permission === "granted") new Notification("ÊôÇÈñìÂà∞ÔºÅ", { body: `ÂÆåÊàê‰∫Ü ${defaultDuration} ÂàÜÈêòÔºÅ` });
            
            const btn = document.getElementById('timer-toggle-btn');
            btn.innerText = "ÂÆåÊàê";
            btn.style.background = "#7f8c8d";
            alert(`‚è∞ ÊôÇÈñìÂà∞ÔºÅ\nÂ∑≤Â∞á ${defaultDuration} ÂàÜÈêòË®àÂÖ•ÁÜ±ÂäõÂúñÔºÅ`);
        }

        // --- 3. ÂΩ©Â∏∂ÁâπÊïà ---
        const canvas = document.getElementById('confetti-canvas');
        const ctx = canvas.getContext('2d');
        let particles = []; let animationId = null;
        function resizeCanvas() { canvas.width = window.innerWidth; canvas.height = window.innerHeight; }
        window.addEventListener('resize', resizeCanvas); resizeCanvas();

        function createParticle(baseColor) {
            return {
                x: Math.random() * canvas.width, y: Math.random() * canvas.height - canvas.height, 
                size: Math.random() * 8 + 4, 
                color: baseColor || colorPalette[Math.floor(Math.random() * colorPalette.length)],
                speedY: Math.random() * 3 + 2, speedX: Math.random() * 2 - 1,
                rotation: Math.random() * 360, rotationSpeed: Math.random() * 4 - 2
            };
        }
        function startConfetti(color) { 
            particles = []; 
            for (let i = 0; i < 150; i++) particles.push(createParticle(color)); 
            if (!animationId) loopConfetti(); 
        }
        function stopConfetti() { if (animationId) { cancelAnimationFrame(animationId); animationId = null; } ctx.clearRect(0, 0, canvas.width, canvas.height); }
        function loopConfetti() {
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            particles.forEach((p, index) => {
                p.y += p.speedY; p.x += p.speedX; p.rotation += p.rotationSpeed;
                ctx.save(); ctx.translate(p.x, p.y); ctx.rotate(p.rotation * Math.PI / 180);
                ctx.fillStyle = p.color; ctx.fillRect(-p.size/2, -p.size/2, p.size, p.size); ctx.restore();
                if (p.y > canvas.height) particles[index] = createParticle(particles[index].color);
            });
            animationId = requestAnimationFrame(loopConfetti);
        }
        function triggerCelebration(color) { startConfetti(color); setTimeout(stopConfetti, 3000); }

        // --- 4. Èü≥Êïà ---
        let audioCtx = null; let isMuted = false;
        function initAudio() { if (!audioCtx) audioCtx = new (window.AudioContext || window.webkitAudioContext)(); }
        function playTone(freq, duration, type = 'sine') {
            if (isMuted || !audioCtx) return;
            try {
                const osc = audioCtx.createOscillator(); const gain = audioCtx.createGain();
                osc.type = type; osc.frequency.value = freq;
                osc.connect(gain); gain.connect(audioCtx.destination);
                osc.start(); gain.gain.exponentialRampToValueAtTime(0.00001, audioCtx.currentTime + duration);
                osc.stop(audioCtx.currentTime + duration);
            } catch(e) {}
        }
        function playApplause() {
            if (isMuted || !audioCtx) return;
            const duration = 2.0; const bufferSize = audioCtx.sampleRate * duration;
            const buffer = audioCtx.createBuffer(1, bufferSize, audioCtx.sampleRate);
            const data = buffer.getChannelData(0);
            for (let i = 0; i < bufferSize; i++) data[i] = (Math.random() * 2 - 1) * Math.exp(-i / (audioCtx.sampleRate * 0.5));
            const noise = audioCtx.createBufferSource(); noise.buffer = buffer;
            const gain = audioCtx.createGain(); const filter = audioCtx.createBiquadFilter();
            filter.type = 'lowpass'; filter.frequency.value = 1000;
            noise.connect(filter); filter.connect(gain); gain.connect(audioCtx.destination);
            gain.gain.setValueAtTime(0.5, audioCtx.currentTime); gain.gain.exponentialRampToValueAtTime(0.001, audioCtx.currentTime + duration);
            noise.start();
        }
        function playCheer() {
            initAudio(); playTone(523.25, 0.2, 'triangle'); setTimeout(() => playTone(659.25, 0.2, 'triangle'), 150);
            setTimeout(() => playTone(783.99, 0.4, 'square'), 300); setTimeout(playApplause, 300);
        }
        function toggleSound() {
            isMuted = !isMuted;
            document.getElementById('sound-btn').innerHTML = isMuted ? 'üîá' : 'üîä';
            document.getElementById('sound-btn').classList.toggle('active', !isMuted);
            if(!isMuted) playTone(800, 0.05, 'triangle');
        }

        // --- 5. Ê†∏ÂøÉÈÇèËºØ ---
        let defaultSubjects = [
            { name: "Êï∏Â≠∏", weight: 5, color: "#e74c3c" }, { name: "Áâ©ÁêÜ", weight: 5, color: "#3498db" },
            { name: "ÂåñÂ≠∏", weight: 4, color: "#9b59b6" }, { name: "ÁîüÁâ©", weight: 3, color: "#2ecc71" },
            { name: "Ëã±Êñá", weight: 3, color: "#f1c40f" }, { name: "ÂúãÊñá", weight: 2, color: "#e67e22" },
            { name: "Âú∞Áßë", weight: 2, color: "#2ecc71" }, { name: "Á®ãÂºè", weight: 4, color: "#3498db" },
            { name: "Â∞àÈ°å", weight: 3, color: "#9b59b6" }, { name: "Ëá™Ë®Ç1", weight: 1, color: "#95a5a6" }
        ];

        let activePool = []; let currentDeck = []; let isDeckMode = false;

        window.addEventListener('load', () => {
            document.body.addEventListener('click', () => initAudio(), { once: true });
            try { loadSettings(); } catch (e) { localStorage.removeItem('studyApp_data'); }
            renderSetupList();
            
            const savedFont = localStorage.getItem('studyApp_fontSize');
            if(savedFont) {
                currentFontSize = parseInt(savedFont);
                document.documentElement.style.setProperty('--list-font-size', currentFontSize + 'px');
            }
            const savedTimer = localStorage.getItem('studyApp_timerPref');
            if(savedTimer) {
                defaultDuration = parseInt(savedTimer);
                timerSeconds = defaultDuration * 60;
                updateTimerDisplay();
            }
            const savedGoal = localStorage.getItem('studyApp_dailyGoal');
            if(savedGoal) {
                dailyGoal = parseInt(savedGoal);
                document.getElementById('daily-goal-input').value = dailyGoal;
            }
        });

        function renderSetupList() {
            const container = document.getElementById('subject-list');
            if (!container) return;
            container.innerHTML = '';
            defaultSubjects.forEach((sub, index) => {
                const row = document.createElement('div');
                row.className = 'subject-row';
                const isChecked = sub.checked !== false;
                const subColor = sub.color || '#3498db';
                row.innerHTML = `
                    <div class="color-dot" style="background-color:${subColor};" onclick="changeColor(${index}, this)"></div>
                    <input type="checkbox" class="sub-check" id="chk-${index}" ${isChecked ? 'checked' : ''} onchange="playTone(800, 0.05, 'triangle')">
                    <input type="text" class="name-input" value="${sub.name}" id="name-${index}" onchange="updateName(${index}, this.value)" style="color:${isChecked ? 'white' : '#777'}">
                    <input type="number" id="w-${index}" class="weight-input" value="${sub.weight}" min="1" max="9" inputmode="numeric" onfocus="this.select()">
                    <div class="order-btn-group">
                        <button class="order-btn" onclick="moveItem(${index}, -1)">‚ñ≤</button>
                        <button class="order-btn" onclick="moveItem(${index}, 1)">‚ñº</button>
                    </div>
                `;
                container.appendChild(row);
            });
            try {
                const storedMode = localStorage.getItem('studyApp_deckMode');
                if(storedMode === 'true') document.getElementById('deck-mode-toggle').checked = true;
            } catch(e) {}
        }

        function changeColor(index, dotElement) {
            playTone(800, 0.05, 'triangle');
            const currentColor = defaultSubjects[index].color || '#3498db';
            const nextColor = getNextColor(currentColor);
            defaultSubjects[index].color = nextColor;
            dotElement.style.backgroundColor = nextColor;
            saveSettings();
        }
