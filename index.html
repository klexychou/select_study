<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    
    <title>ç§‘å­¸ç­è®€æ›¸è¨ˆç•«</title>
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="theme-color" content="#121212">
    <link rel="apple-touch-icon" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100' style='background-color: %232c3e50'%3E%3Crect width='100' height='100' fill='%232c3e50'/%3E%3Ctext y='50%25' x='50%25' dominant-baseline='central' text-anchor='middle' font-size='60' %3EğŸ“š%3C/text%3E%3C/svg%3E">

    <style>
        /* --- å…¨å±€è¨­å®š --- */
        body {
            font-family: "Microsoft JhengHei", -apple-system, BlinkMacSystemFont, sans-serif;
            background-color: #121212;
            color: #ffffff;
            margin: 0;
            height: 100vh;
            overflow: hidden;
            display: flex;
            flex-direction: column;
            padding-top: env(safe-area-inset-top);
            padding-bottom: env(safe-area-inset-bottom);
        }

        .hidden { display: none !important; }

        button {
            border: none;
            border-radius: 12px;
            font-weight: bold;
            cursor: pointer;
            transition: transform 0.1s;
            -webkit-tap-highlight-color: transparent;
        }
        button:active { transform: scale(0.96); }

        /* --- æ¨™é¡Œåˆ— --- */
        .header-nav {
            padding: 15px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: #1e1e1e;
            border-bottom: 1px solid #333;
        }
        h2 { margin: 0; color: #3498db; font-size: 20px; }
        .icon-btn {
            background: none;
            font-size: 16px;
            padding: 5px 10px;
            color: #aaa;
            border: 1px solid #444;
            border-radius: 15px;
        }

        /* --- 1. è¨­å®šé é¢ --- */
        #setup-screen {
            flex: 1;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }
        
        .control-bar {
            background-color: #252525;
            padding: 15px 20px;
            margin: 10px 15px;
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            border: 1px solid #333;
        }

        .switch-container {
            position: relative;
            display: inline-block;
            width: 50px;
            height: 28px;
        }
        .switch-container input { opacity: 0; width: 0; height: 0; }
        .slider {
            position: absolute;
            cursor: pointer;
            top: 0; left: 0; right: 0; bottom: 0;
            background-color: #555;
            transition: .4s;
            border-radius: 34px;
        }
        .slider:before {
            position: absolute;
            content: "";
            height: 20px;
            width: 20px;
            left: 4px;
            bottom: 4px;
            background-color: white;
            transition: .4s;
            border-radius: 50%;
        }
        input:checked + .slider { background-color: #e67e22; }
        input:checked + .slider:before { transform: translateX(22px); }

        /* åˆ—è¡¨å€åŸŸ */
        .list-container {
            flex: 1;
            overflow-y: auto;
            padding: 0 15px 20px 15px;
        }

        .subject-row {
            display: flex;
            align-items: center;
            background-color: #1e1e1e;
            margin-bottom: 10px;
            padding: 10px 15px;
            border-radius: 10px;
            border: 1px solid #333;
        }

        input[type="checkbox"].sub-check {
            transform: scale(1.5);
            margin-right: 15px;
            accent-color: #3498db; 
        }

        /* ç§‘ç›®åç¨±é¡¯ç¤º */
        .subject-name { flex: 1; font-size: 18px; color: #ddd; }
        
        /* è‡ªè¨‚ç§‘ç›®è¼¸å…¥æ¡†æ¨£å¼ */
        .custom-name-input {
            flex: 1;
            background: transparent;
            border: none;
            border-bottom: 1px dashed #555;
            color: #4cd137; /* è‡ªè¨‚ç§‘ç›®ç”¨ç¶ è‰²é¡¯ç¤º */
            font-size: 18px;
            padding: 5px 0;
            font-family: inherit;
            margin-right: 10px;
        }
        .custom-name-input:focus {
            outline: none;
            border-bottom: 1px solid #4cd137;
        }

        .weight-input {
            width: 45px;
            height: 35px;
            text-align: center;
            font-size: 18px;
            background-color: #2c3e50;
            color: #fff;
            border: 1px solid #444;
            border-radius: 8px;
            margin-left: 10px;
        }

        .start-btn {
            margin: 10px 15px 20px 15px;
            padding: 18px;
            background: linear-gradient(135deg, #2ecc71, #27ae60);
            color: white;
            font-size: 20px;
            box-shadow: 0 4px 10px rgba(46, 204, 113, 0.3);
            border-radius: 16px;
        }

        /* --- 2. æŠ½ç±¤é é¢ --- */
        #draw-screen {
            flex: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            position: relative;
        }

        #deck-status {
            position: absolute;
            top: 30px;
            right: 20px;
            background: #e67e22;
            padding: 8px 15px;
            border-radius: 20px;
            font-size: 14px;
            font-weight: bold;
            color: white;
        }

        #result-display {
            font-size: 60px;
            font-weight: bold;
            color: #e74c3c;
            margin-bottom: 10px;
            text-align: center;
            padding: 0 20px;
            word-break: break-word; /* é˜²æ­¢é•·åå­—è·‘ç‰ˆ */
        }

        #prob-display {
            color: #7f8c8d;
            font-size: 16px;
            margin-bottom: 50px;
        }

        .action-btn {
            padding: 20px 80px;
            font-size: 24px;
            background: linear-gradient(135deg, #3498db, #2980b9);
            color: white;
            border-radius: 50px;
            box-shadow: 0 10px 20px rgba(0,0,0,0.3);
            margin-bottom: 20px;
        }
        .action-btn:disabled {
            background: #555;
            color: #888;
            box-shadow: none;
            cursor: not-allowed;
        }
        .back-btn {
            background: transparent;
            color: #7f8c8d;
            font-size: 14px;
            margin-top: 20px;
            padding: 10px 20px;
        }

        /* --- 3. çµ±è¨ˆé é¢ --- */
        #stats-screen {
            flex: 1;
            display: flex;
            flex-direction: column;
            background: #121212;
            overflow: hidden;
        }
        .chart-wrapper {
            flex: 1;
            display: flex;
            flex-direction: column;
            justify-content: flex-end;
            padding: 20px;
            padding-bottom: 40px;
        }
        .chart-container {
            display: flex;
            align-items: flex-end;
            justify-content: space-around;
            height: 300px;
            border-bottom: 2px solid #555;
            padding-bottom: 5px;
            overflow-x: auto; /* å…è¨±æ©«å‘æ»‘å‹• */
        }
        .bar-col {
            flex: 0 0 40px; /* å›ºå®šå¯¬åº¦é¿å…å¤ªæ“  */
            display: flex;
            flex-direction: column;
            align-items: center;
            margin: 0 5px;
        }
        .bar-val { font-size: 10px; color: #aaa; margin-bottom: 4px; }
        .bar {
            width: 100%;
            background: #3498db;
            border-radius: 4px 4px 0 0;
            transition: height 0.6s ease-out;
            min-height: 2px;
        }
        .bar.highlight { background: #e74c3c; }
        .bar-label {
            margin-top: 8px;
            font-size: 10px;
            color: #ccc;
            writing-mode: vertical-rl;
            text-orientation: mixed;
            max-height: 80px;
            overflow: hidden;
        }
    </style>
</head>
<body>

    <div id="setup-screen">
        <div class="header-nav">
            <h2>è®€æ›¸è¨ˆç•« V5</h2>
            <button class="icon-btn" onclick="showStats()">ğŸ“Š çµ±è¨ˆ</button>
        </div>
        
        <div class="control-bar">
            <div>
                <div style="font-weight:bold; color:#ddd">æ¶ˆè€—æ¨¡å¼</div>
                <div style="font-size:12px; color:#aaa;">ä¸é‡è¤‡æŠ½é¸</div>
            </div>
            <label class="switch-container">
                <input type="checkbox" id="deck-mode-toggle">
                <span class="slider"></span>
            </label>
        </div>
        
        <div class="list-container" id="subject-list"></div>
        <button class="start-btn" onclick="startSession()">é–‹å§‹åŸ·è¡Œ</button>
    </div>

    <div id="draw-screen" class="hidden">
        <div id="deck-status" class="hidden"></div>
        <div id="result-display">?</div>
        <div id="prob-display">æº–å‚™å°±ç·’</div>
        <button id="draw-btn" class="action-btn" onclick="draw()">æŠ½é¸</button>
        <button class="back-btn" onclick="goBack()">â† è¿”å›è¨­å®š</button>
    </div>

    <div id="stats-screen" class="hidden">
        <div class="header-nav">
            <h2>è¿‘7æ—¥çµ±è¨ˆ</h2>
            <button class="icon-btn" onclick="closeStats()">âœ• é—œé–‰</button>
        </div>
        <div class="chart-wrapper">
            <div id="chart-area" class="chart-container"></div>
            <div style="text-align:center; margin-top:10px; color:#666; font-size:12px;">åƒ…é¡¯ç¤ºéå» 7 å¤©æ•¸æ“š</div>
        </div>
        <div style="text-align:center; padding:20px;">
            <button onclick="clearHistory()" style="color:#e74c3c; background:none; border:1px solid #e74c3c; padding:8px 20px; font-size:14px; border-radius:20px;">æ¸…é™¤ç´€éŒ„</button>
        </div>
    </div>

    <script>
        // --- è®Šæ•¸èˆ‡è¨­å®š ---
        // æ“´å¢åˆ° 12 å€‹ç§‘ç›®
        // isCustom: true ä»£è¡¨é€™å€‹æ¬„ä½æ˜¯è¼¸å…¥æ¡†
        const defaultSubjects = [
            { name: "æ•¸å­¸", weight: 5, isCustom: false },
            { name: "ç‰©ç†", weight: 5, isCustom: false },
            { name: "åŒ–å­¸", weight: 4, isCustom: false },
            { name: "ç”Ÿç‰©", weight: 3, isCustom: false },
            { name: "è‹±æ–‡", weight: 3, isCustom: false },
            { name: "åœ‹æ–‡", weight: 2, isCustom: false },
            { name: "åœ°ç§‘", weight: 2, isCustom: false },
            { name: "ç¨‹å¼", weight: 4, isCustom: true },  // ID 7: é è¨­ç¨‹å¼ï¼Œä½†å¯æ”¹
            { name: "å°ˆé¡Œ", weight: 3, isCustom: true },  // ID 8: é è¨­å°ˆé¡Œï¼Œä½†å¯æ”¹
            { name: "è‡ªè¨‚1", weight: 1, isCustom: true },  // ID 9
            { name: "è‡ªè¨‚2", weight: 1, isCustom: true },  // ID 10
            { name: "è‡ªè¨‚3", weight: 1, isCustom: true }   // ID 11
        ];

        let activePool = [];
        let currentDeck = [];
        let isDeckMode = false;

        // --- åˆå§‹åŒ– ---
        window.addEventListener('load', () => {
            try { loadSettings(); } catch(e){}
            renderSetupList();
        });

        // --- æ ¸å¿ƒåŠŸèƒ½ ---
        function renderSetupList() {
            const container = document.getElementById('subject-list');
            container.innerHTML = '';
            
            defaultSubjects.forEach((sub, index) => {
                const row = document.createElement('div');
                row.className = 'subject-row';
                const isChecked = sub.checked !== false;

                // åˆ¤æ–·æ˜¯ã€Œå›ºå®šæ–‡å­—ã€é‚„æ˜¯ã€Œè¼¸å…¥æ¡†ã€
                let nameHtml = '';
                if (sub.isCustom) {
                    // è‡ªè¨‚ç§‘ç›®é¡¯ç¤ºè¼¸å…¥æ¡†
                    nameHtml = `<input type="text" id="name-${index}" class="custom-name-input" value="${sub.name}" placeholder="è¼¸å…¥åç¨±">`;
                } else {
                    // å›ºå®šç§‘ç›®é¡¯ç¤ºæ–‡å­—
                    nameHtml = `<label for="chk-${index}" class="subject-name">${sub.name}</label>`;
                }

                row.innerHTML = `
                    <input type="checkbox" class="sub-check" id="chk-${index}" ${isChecked ? 'checked' : ''}>
                    ${nameHtml}
                    <input type="number" id="w-${index}" class="weight-input" 
                           value="${sub.weight}" min="1" max="9" inputmode="numeric">
                `;
                container.appendChild(row);
            });

            try {
                const storedMode = localStorage.getItem('studyApp_deckMode');
                if(storedMode === 'true') document.getElementById('deck-mode-toggle').checked = true;
            } catch(e){}
        }

        function startSession() {
            try {
                activePool = [];
                const checkboxes = document.querySelectorAll('#subject-list .sub-check');
                
                checkboxes.forEach((chk, index) => {
                    const weightInput = document.getElementById(`w-${index}`);
                    let val = parseInt(weightInput.value) || 1;
                    if (val > 9) val = 9; if (val < 1) val = 1;

                    // å„²å­˜æ¬Šé‡èˆ‡å‹¾é¸ç‹€æ…‹
                    defaultSubjects[index].checked = chk.checked;
                    defaultSubjects[index].weight = val;

                    // â­ï¸ é—œéµï¼šå¦‚æœæœ‰è¼¸å…¥æ¡†ï¼Œä¹Ÿè¦å„²å­˜ä½¿ç”¨è€…æ”¹çš„åå­—
                    const nameInput = document.getElementById(`name-${index}`);
                    if (nameInput) {
                        defaultSubjects[index].name = nameInput.value;
                    }

                    if (chk.checked) {
                        activePool.push({ name: defaultSubjects[index].name, weight: val });
                    }
                });

                if (activePool.length < 1) { alert("è«‹è‡³å°‘å‹¾é¸ 1 å€‹ç§‘ç›®ï¼"); return; }

                saveSettings(); // å„²å­˜

                isDeckMode = document.getElementById('deck-mode-toggle').checked;
                if (isDeckMode) {
                    currentDeck = JSON.parse(JSON.stringify(activePool));
                    document.getElementById('deck-status').classList.remove('hidden');
                    updateDeckStatus();
                } else {
                    document.getElementById('deck-status').classList.add('hidden');
                }

                switchScreen('draw-screen');
                resetDrawScreen();
            } catch (err) { alert("Error: " + err.message); }
        }

        function draw() {
            let pool = isDeckMode ? currentDeck : activePool;
            if (pool.length === 0) { alert("æ‰€æœ‰ç§‘ç›®éƒ½è®€å®Œäº†ï¼"); return; }

            const totalWeight = pool.reduce((sum, item) => sum + item.weight, 0);
            let randomNum = Math.random() * totalWeight;
            let selectedIndex = -1, selectedItem = null;

            for (let i = 0; i < pool.length; i++) {
                randomNum -= pool[i].weight;
                if (randomNum < 0) { selectedItem = pool[i]; selectedIndex = i; break; }
            }

            if(selectedItem) {
                showResult(selectedItem, totalWeight);
                recordHistory(selectedItem.name); 
            }

            if (isDeckMode) {
                currentDeck.splice(selectedIndex, 1);
                updateDeckStatus();
                if (currentDeck.length === 0) {
                    const btn = document.getElementById('draw-btn');
                    btn.innerText = "å…¨éƒ¨å®Œæˆ";
                    btn.disabled = true;
                    document.getElementById('prob-display').innerText = "æœ¬è¼ªçµæŸ";
                }
            }
        }

        function showResult(item, totalW) {
            const resDisplay = document.getElementById('result-display');
            resDisplay.innerText = item.name;
            // ç°¡å–®åˆ¤æ–·ï¼šåŒ…å« æ•¸/ç†/åŒ–/ç¨‹/ç”Ÿ é¡¯ç¤ºç´…è‰²ï¼Œå…¶ä»–è—è‰²
            const isScience = /[æ•¸ç†åŒ–ç¨‹ç”Ÿ]/.test(item.name) || /Math|Phys|Chem|Code|Bio/i.test(item.name);
            resDisplay.style.color = isScience ? "#e74c3c" : "#3498db";

            if (!isDeckMode) {
                const prob = ((item.weight / totalW) * 100).toFixed(1);
                document.getElementById('prob-display').innerText = `æ©Ÿç‡: ${prob}%`;
            } else {
                document.getElementById('prob-display').innerText = "å·²é¸å®š";
            }
        }

        // --- æ­·å²ç´€éŒ„èˆ‡çµ±è¨ˆ ---
        function recordHistory(subjectName) {
            try {
                let history = JSON.parse(localStorage.getItem('study_history') || '[]');
                history.push({ sub: subjectName, time: Date.now() });
                const sevenDaysAgo = Date.now() - 7 * 24 * 60 * 60 * 1000;
                history = history.filter(h => h.time > sevenDaysAgo);
                localStorage.setItem('study_history', JSON.stringify(history));
            } catch(e) {}
        }

        function showStats() {
            switchScreen('stats-screen');
            renderChart();
        }

        function renderChart() {
            const chartArea = document.getElementById('chart-area');
            chartArea.innerHTML = ''; 

            let history = [];
            try { history = JSON.parse(localStorage.getItem('study_history') || '[]'); } catch(e){}

            if (history.length === 0) {
                chartArea.innerHTML = '<div style="color:#555; align-self:center; width:100%; text-align:center;">æš«ç„¡æ•¸æ“š<br>å»æŠ½ç±¤å¹¾æ¬¡å§ï¼</div>';
                return;
            }

            const counts = {};
            history.forEach(h => { counts[h.sub] = (counts[h.sub] || 0) + 1; });
            const maxCount = Math.max(...Object.values(counts));
            const subjectsToShow = Object.keys(counts).length > 0 ? Object.keys(counts) : [];

            subjectsToShow.forEach(sub => {
                const count = counts[sub] || 0;
                const heightPercent = (count / maxCount) * 100;
                const isScience = /[æ•¸ç†åŒ–ç¨‹ç”Ÿ]/.test(sub);
                
                const col = document.createElement('div');
                col.className = 'bar-col';
                col.innerHTML = `
                    <div class="bar-val">${count}</div>
                    <div class="bar ${isScience ? 'highlight' : ''}" style="height: ${heightPercent}%"></div>
                    <div class="bar-label">${sub}</div>
                `;
                chartArea.appendChild(col);
            });
        }

        function clearHistory() {
            if(confirm("ç¢ºå®šè¦æ¸…é™¤æ‰€æœ‰çµ±è¨ˆç´€éŒ„å—ï¼Ÿ")) {
                localStorage.removeItem('study_history');
                renderChart();
            }
        }

        // --- è¼”åŠ©åŠŸèƒ½ ---
        function switchScreen(screenId) {
            ['setup-screen', 'draw-screen', 'stats-screen'].forEach(id => {
                const el = document.getElementById(id);
                if (id === screenId) el.classList.remove('hidden');
                else el.classList.add('hidden');
            });
        }
        function closeStats() { switchScreen('setup-screen'); }
        function goBack() { switchScreen('setup-screen'); }
        function updateDeckStatus() { document.getElementById('deck-status').innerText = `å‰©é¤˜: ${currentDeck.length}`; }
        function resetDrawScreen() {
            document.getElementById('result-display').innerText = "æº–å‚™";
            document.getElementById('result-display').style.color = "#fff";
            document.getElementById('prob-display').innerText = "é»æ“Šé–‹å§‹";
            const btn = document.getElementById('draw-btn');
            btn.disabled = false; btn.innerText = "æŠ½é¸";
        }
        function saveSettings() {
            try {
                const toggle = document.getElementById('deck-mode-toggle');
                const data = { subjects: defaultSubjects, deckMode: toggle ? toggle.checked : false };
                localStorage.setItem('studyApp_data', JSON.stringify(data.subjects));
                localStorage.setItem('studyApp_deckMode', data.deckMode);
            } catch(e){}
        }
        function loadSettings() {
            const saved = localStorage.getItem('studyApp_data');
            if (saved) {
                const parsed = JSON.parse(saved);
                parsed.forEach((s, i) => { 
                    if(defaultSubjects[i]) { 
                        defaultSubjects[i].weight = s.weight; 
                        defaultSubjects[i].checked = s.checked;
                        // ä¹Ÿè¦è®€å–åç¨±
                        if (s.name) defaultSubjects[i].name = s.name;
                    }
                });
            }
        }
    </script>
</body>
</html>
