<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>ç§‘å­¸ç­è®€æ›¸è¨ˆç•« V7</title>
    
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="theme-color" content="#121212">
    <link rel="apple-touch-icon" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100' style='background-color: %232c3e50'%3E%3Crect width='100' height='100' fill='%232c3e50'/%3E%3Ctext y='50%25' x='50%25' dominant-baseline='central' text-anchor='middle' font-size='60' %3EğŸ“š%3C/text%3E%3C/svg%3E">

    <style>
        /* --- å…¨å±€è¨­å®š --- */
        body {
            font-family: "Microsoft JhengHei", -apple-system, BlinkMacSystemFont, sans-serif;
            background-color: #121212;
            color: #ffffff;
            margin: 0;
            height: 100vh;
            overflow: hidden;
            display: flex;
            flex-direction: column;
            padding-top: env(safe-area-inset-top);
            padding-bottom: env(safe-area-inset-bottom);
            user-select: none;
        }

        .hidden { display: none !important; }

        button {
            border: none;
            border-radius: 12px;
            font-weight: bold;
            cursor: pointer;
            transition: transform 0.1s;
            -webkit-tap-highlight-color: transparent;
            outline: none;
        }
        button:active { transform: scale(0.92); }

        /* --- å½©å¸¶ Canvas --- */
        #confetti-canvas {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none; /* è®“é»æ“Šå¯ä»¥ç©¿é€ */
            z-index: 999;
        }

        /* --- Header --- */
        .header-nav {
            padding: 10px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: #1e1e1e;
            border-bottom: 1px solid #333;
            min-height: 50px;
            z-index: 10;
        }
        h2 { margin: 0; color: #3498db; font-size: 18px; }
        .icon-btn {
            background: #333; color: #ddd; font-size: 16px; padding: 8px 12px; border-radius: 8px; margin-left: 8px;
        }
        .icon-btn.active { background: #3498db; color: white; }

        /* --- è¨­å®šé é¢ --- */
        #setup-screen { flex: 1; display: flex; flex-direction: column; overflow: hidden; }
        
        .control-bar {
            background-color: #252525;
            padding: 12px 20px;
            margin: 10px 15px;
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            border: 1px solid #333;
        }

        .switch-container { position: relative; display: inline-block; width: 50px; height: 28px; }
        .switch-container input { opacity: 0; width: 0; height: 0; }
        .slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: #555; transition: .4s; border-radius: 34px; }
        .slider:before { position: absolute; content: ""; height: 20px; width: 20px; left: 4px; bottom: 4px; background-color: white; transition: .4s; border-radius: 50%; }
        input:checked + .slider { background-color: #e67e22; }
        input:checked + .slider:before { transform: translateX(22px); }

        /* åˆ—è¡¨ */
        .list-container { flex: 1; overflow-y: auto; padding: 0 15px 100px 15px; }
        
        .subject-row {
            display: flex; align-items: center; background-color: #1e1e1e;
            margin-bottom: 8px; padding: 8px 12px; border-radius: 10px; border: 1px solid #333;
        }
        input[type="checkbox"].sub-check { transform: scale(1.3); margin-right: 10px; accent-color: #3498db; }
        
        /* å¯ç·¨è¼¯çš„ç§‘ç›®åç¨± Input */
        .name-input {
            flex: 1;
            font-size: 16px;
            font-weight: 500;
            background: transparent;
            border: none;
            color: white;
            border-bottom: 1px solid transparent;
            padding: 4px 0;
            margin-right: 10px;
            border-radius: 0;
        }
        .name-input:focus {
            border-bottom: 1px solid #3498db;
            outline: none;
            background: #252525;
        }

        .weight-input { width: 40px; height: 30px; text-align: center; font-size: 16px; background-color: #2c3e50; color: #fff; border: 1px solid #444; border-radius: 6px; margin-right: 10px;}

        .order-btn-group { display: flex; flex-direction: column; gap: 2px; }
        .order-btn {
            background: #333; color: #aaa; border-radius: 4px; padding: 2px 8px; font-size: 10px; height: 18px; line-height: 14px;
        }
        .order-btn:active { background: #555; color: white; }

        .start-btn {
            position: absolute; bottom: 30px; left: 20px; right: 20px;
            padding: 16px;
            background: linear-gradient(135deg, #2ecc71, #27ae60);
            color: white; font-size: 20px; border-radius: 16px;
            box-shadow: 0 4px 15px rgba(46, 204, 113, 0.4);
            z-index: 20;
        }

        /* --- æŠ½ç±¤é é¢ --- */
        #draw-screen { flex: 1; display: flex; flex-direction: column; align-items: center; justify-content: center; position: relative; z-index: 10;}
        #deck-status { position: absolute; top: 30px; right: 20px; background: #e67e22; padding: 6px 12px; border-radius: 20px; font-size: 14px; font-weight: bold; color: white; }
        #result-display { font-size: 64px; font-weight: 800; color: #e74c3c; margin-bottom: 10px; text-align: center; padding: 0 20px; line-height: 1.2; text-shadow: 0 0 20px rgba(231, 76, 60, 0.5); }
        #prob-display { color: #7f8c8d; font-size: 16px; margin-bottom: 60px; }
        .action-btn { padding: 20px 80px; font-size: 24px; background: linear-gradient(135deg, #3498db, #2980b9); color: white; border-radius: 50px; margin-bottom: 20px; box-shadow: 0 8px 20px rgba(52, 152, 219, 0.4); }
        .action-btn:disabled { background: #555; color: #888; box-shadow: none; }
        .back-btn { background: transparent; color: #7f8c8d; font-size: 14px; padding: 10px 20px; }

        /* --- ç†±åŠ›åœ– (Heatmap) --- */
        #stats-screen { flex: 1; display: flex; flex-direction: column; background: #121212; z-index: 10;}
        .heatmap-container {
            flex: 1;
            padding: 20px;
            overflow-y: auto;
        }
        .heatmap-grid {
            display: grid;
            /* ç¬¬ä¸€æ¬„æ˜¯ç§‘ç›®åï¼Œå¾Œé¢7æ¬„æ˜¯æ—¥æœŸ */
            grid-template-columns: auto repeat(7, 1fr);
            gap: 4px;
            align-items: center;
        }
        .hm-cell {
            width: 100%;
            aspect-ratio: 1;
            border-radius: 4px;
            background-color: #1e1e1e; /* é è¨­ç„¡æ•¸æ“šé¡è‰² */
        }
        .hm-label-row {
            font-size: 10px; color: #888; text-align: center; margin-bottom: 5px;
        }
        .hm-label-col {
            font-size: 12px; color: #ccc; text-align: right; padding-right: 10px;
            white-space: nowrap; overflow: hidden; text-overflow: ellipsis; max-width: 80px;
        }
        
        /* ç†±åŠ›åœ–é¡è‰²ç­‰ç´š */
        .lvl-0 { background-color: #252525; }
        .lvl-1 { background-color: #0e4429; }
        .lvl-2 { background-color: #006d32; }
        .lvl-3 { background-color: #26a641; }
        .lvl-4 { background-color: #39d353; box-shadow: 0 0 5px #39d353; }

    </style>
</head>
<body>

    <canvas id="confetti-canvas"></canvas>

    <div id="setup-screen">
        <div class="header-nav">
            <button id="sound-btn" class="icon-btn active" onclick="toggleSound()">ğŸ”Š</button>
            <h2>è®€æ›¸è¨ˆç•« V7</h2>
            <button class="icon-btn" onclick="showStats()">ğŸ”¥ ç†±åŠ›åœ–</button>
        </div>
        
        <div class="control-bar">
            <div>
                <div style="font-weight:bold; color:#ddd">ä¸é‡è¤‡æ¨¡å¼</div>
                <div style="font-size:12px; color:#aaa;">è®€å®Œä¸€ç§‘å°‘ä¸€ç§‘</div>
            </div>
            <label class="switch-container">
                <input type="checkbox" id="deck-mode-toggle" onchange="playTone(800, 0.05, 'triangle')">
                <span class="slider"></span>
            </label>
        </div>
        
        <div class="list-container" id="subject-list">
            </div>
        <button class="start-btn" onclick="startSession()">ğŸš€ é–‹å§‹åŸ·è¡Œ</button>
    </div>

    <div id="draw-screen" class="hidden">
        <div id="deck-status" class="hidden"></div>
        <div id="result-display">?</div>
        <div id="prob-display">æº–å‚™å°±ç·’</div>
        <button id="draw-btn" class="action-btn" onclick="draw()">æŠ½é¸</button>
        <button class="back-btn" onclick="goBack()">â† è¿”å›è¨­å®š</button>
    </div>

    <div id="stats-screen" class="hidden">
        <div class="header-nav">
            <h2>è®€æ›¸ç†±åŠ›åœ– (è¿‘7æ—¥)</h2>
            <button class="icon-btn" onclick="closeStats()">âœ•</button>
        </div>
        
        <div style="display:grid; grid-template-columns: auto repeat(7, 1fr); gap:4px; padding:10px 20px 0 20px; font-size:10px; color:#666; text-align:center;">
            <div style="width:80px;"></div> <div id="date-headers" style="display:contents;"></div>
        </div>

        <div class="heatmap-container">
            <div id="heatmap-grid" class="heatmap-grid">
                </div>
        </div>
        
        <div style="text-align:center; padding:20px;">
            <button onclick="clearHistory()" style="color:#e74c3c; background:none; border:1px solid #e74c3c; padding:8px 20px; border-radius:20px;">æ¸…é™¤ç´€éŒ„</button>
        </div>
    </div>

    <script>
        // --- 1. å½©å¸¶ç‰¹æ•ˆ (Canvas Confetti) ---
        const canvas = document.getElementById('confetti-canvas');
        const ctx = canvas.getContext('2d');
        let particles = [];
        let animationId = null;

        function resizeCanvas() {
            canvas.width = window.innerWidth;
            canvas.height = window.innerHeight;
        }
        window.addEventListener('resize', resizeCanvas);
        resizeCanvas();

        function createParticle() {
            const colors = ['#e74c3c', '#3498db', '#f1c40f', '#2ecc71', '#9b59b6'];
            return {
                x: Math.random() * canvas.width,
                y: Math.random() * canvas.height - canvas.height, // å¾ä¸Šæ–¹é–‹å§‹
                size: Math.random() * 8 + 4,
                color: colors[Math.floor(Math.random() * colors.length)],
                speedY: Math.random() * 3 + 2,
                speedX: Math.random() * 2 - 1,
                rotation: Math.random() * 360,
                rotationSpeed: Math.random() * 4 - 2
            };
        }

        function startConfetti() {
            particles = [];
            for (let i = 0; i < 150; i++) {
                particles.push(createParticle());
            }
            if (!animationId) loopConfetti();
        }

        function stopConfetti() {
            if (animationId) {
                cancelAnimationFrame(animationId);
                animationId = null;
            }
            ctx.clearRect(0, 0, canvas.width, canvas.height);
        }

        function loopConfetti() {
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            particles.forEach((p, index) => {
                p.y += p.speedY;
                p.x += p.speedX;
                p.rotation += p.rotationSpeed;
                
                // ç•«å½©å¸¶ (ç°¡å–®çŸ©å½¢æ¨¡æ“¬)
                ctx.save();
                ctx.translate(p.x, p.y);
                ctx.rotate(p.rotation * Math.PI / 180);
                ctx.fillStyle = p.color;
                ctx.fillRect(-p.size/2, -p.size/2, p.size, p.size);
                ctx.restore();

                // é‡ç½®è¶…å‡ºè¢å¹•çš„ç²’å­
                if (p.y > canvas.height) {
                    particles[index] = createParticle(); // å¾ªç’°è½ä¸‹
                }
            });
            animationId = requestAnimationFrame(loopConfetti);
        }

        // åœæ­¢ç‰¹æ•ˆå®šæ™‚å™¨
        function triggerCelebration() {
            startConfetti();
            setTimeout(stopConfetti, 3000); // 3ç§’å¾Œåœæ­¢
        }

        // --- 2. éŸ³æ•ˆç³»çµ± (Web Audio API - æ­¡å‘¼è²) ---
        let audioCtx = null;
        let isMuted = false;

        function initAudio() {
            if (!audioCtx) audioCtx = new (window.AudioContext || window.webkitAudioContext)();
        }

        function playTone(freq, duration, type = 'sine') {
            if (isMuted || !audioCtx) return;
            try {
                const osc = audioCtx.createOscillator();
                const gain = audioCtx.createGain();
                osc.type = type;
                osc.frequency.value = freq;
                osc.connect(gain);
                gain.connect(audioCtx.destination);
                osc.start();
                gain.gain.exponentialRampToValueAtTime(0.00001, audioCtx.currentTime + duration);
                osc.stop(audioCtx.currentTime + duration);
            } catch(e) {}
        }

        // æ¨¡æ“¬æŒè² (ç²‰ç´…å™ªéŸ³ + éš¨æ©Ÿ)
        function playApplause() {
            if (isMuted || !audioCtx) return;
            const duration = 2.0;
            const bufferSize = audioCtx.sampleRate * duration;
            const buffer = audioCtx.createBuffer(1, bufferSize, audioCtx.sampleRate);
            const data = buffer.getChannelData(0);
            
            for (let i = 0; i < bufferSize; i++) {
                data[i] = (Math.random() * 2 - 1) * Math.exp(-i / (audioCtx.sampleRate * 0.5)); // è¡°æ¸›
            }

            const noise = audioCtx.createBufferSource();
            noise.buffer = buffer;
            const gain = audioCtx.createGain();
            // è®“è²éŸ³åƒäººç¾¤
            const filter = audioCtx.createBiquadFilter();
            filter.type = 'lowpass';
            filter.frequency.value = 1000;

            noise.connect(filter);
            filter.connect(gain);
            gain.connect(audioCtx.destination);
            
            gain.gain.setValueAtTime(0.5, audioCtx.currentTime);
            gain.gain.exponentialRampToValueAtTime(0.001, audioCtx.currentTime + duration);
            
            noise.start();
        }

        function playCheer() {
            initAudio();
            // 1. å‹åˆ©è™Ÿè§’
            playTone(523.25, 0.2, 'triangle'); // Do
            setTimeout(() => playTone(659.25, 0.2, 'triangle'), 150); // Mi
            setTimeout(() => playTone(783.99, 0.4, 'square'), 300); // Sol (å¼·çƒˆ)
            
            // 2. æŒè²
            setTimeout(playApplause, 300);
        }

        function toggleSound() {
            isMuted = !isMuted;
            document.getElementById('sound-btn').innerHTML = isMuted ? 'ğŸ”‡' : 'ğŸ”Š';
            document.getElementById('sound-btn').classList.toggle('active', !isMuted);
            if(!isMuted) playTone(800, 0.05, 'triangle');
        }

        // --- 3. æ ¸å¿ƒé‚è¼¯ ---
        
        // é è¨­è³‡æ–™ + 5å€‹è‡ªè¨‚ç§‘ç›®
        let defaultSubjects = [
            { name: "æ•¸å­¸", weight: 5 }, { name: "ç‰©ç†", weight: 5 },
            { name: "åŒ–å­¸", weight: 4 }, { name: "ç”Ÿç‰©", weight: 3 },
            { name: "è‹±æ–‡", weight: 3 }, { name: "åœ‹æ–‡", weight: 2 },
            { name: "åœ°ç§‘", weight: 2 }, { name: "ç¨‹å¼", weight: 4 },
            { name: "å°ˆé¡Œ", weight: 3 },
            { name: "è‡ªè¨‚ç§‘ç›® 1", weight: 1 }, { name: "è‡ªè¨‚ç§‘ç›® 2", weight: 1 },
            { name: "è‡ªè¨‚ç§‘ç›® 3", weight: 1 }, { name: "è‡ªè¨‚ç§‘ç›® 4", weight: 1 },
            { name: "è‡ªè¨‚ç§‘ç›® 5", weight: 1 }
        ];

        let activePool = [];
        let currentDeck = [];
        let isDeckMode = false;

        window.addEventListener('load', () => {
            document.body.addEventListener('click', () => initAudio(), { once: true });
            try { loadSettings(); } catch (e) { localStorage.removeItem('studyApp_data'); }
            renderSetupList();
        });

        function renderSetupList() {
            const container = document.getElementById('subject-list');
            if (!container) return;
            container.innerHTML = '';
            
            defaultSubjects.forEach((sub, index) => {
                const row = document.createElement('div');
                row.className = 'subject-row';
                const isChecked = sub.checked !== false;
                
                // æ³¨æ„ï¼šé€™è£¡å°‡ç§‘ç›®åç¨±æ”¹æˆ <input>
                row.innerHTML = `
                    <input type="checkbox" class="sub-check" id="chk-${index}" ${isChecked ? 'checked' : ''} onchange="playTone(800, 0.05, 'triangle')">
                    <input type="text" class="name-input" value="${sub.name}" id="name-${index}" onchange="updateName(${index}, this.value)">
                    <input type="number" id="w-${index}" class="weight-input" 
                           value="${sub.weight}" min="1" max="9" inputmode="numeric" onfocus="this.select()">
                    
                    <div class="order-btn-group">
                        <button class="order-btn" onclick="moveItem(${index}, -1)">â–²</button>
                        <button class="order-btn" onclick="moveItem(${index}, 1)">â–¼</button>
                    </div>
                `;
                container.appendChild(row);
            });
            
            try {
                const storedMode = localStorage.getItem('studyApp_deckMode');
                if(storedMode === 'true') document.getElementById('deck-mode-toggle').checked = true;
            } catch(e) {}
        }

        function updateName(index, newName) {
            defaultSubjects[index].name = newName;
            saveSettings();
        }

        function moveItem(index, direction) {
            playTone(800, 0.05, 'triangle');
            const newIndex = index + direction;
            if (newIndex < 0 || newIndex >= defaultSubjects.length) return;
            saveCurrentUIValues();
            [defaultSubjects[index], defaultSubjects[newIndex]] = [defaultSubjects[newIndex], defaultSubjects[index]];
            renderSetupList();
            saveSettings();
        }

        function saveCurrentUIValues() {
            const checkboxes = document.querySelectorAll('#subject-list .sub-check');
            checkboxes.forEach((chk, index) => {
                const weightInput = document.getElementById(`w-${index}`);
                const nameInput = document.getElementById(`name-${index}`);
                let val = parseInt(weightInput.value) || 1;
                
                defaultSubjects[index].checked = chk.checked;
                defaultSubjects[index].weight = val;
                defaultSubjects[index].name = nameInput.value; // ç¢ºä¿åç¨±ä¹Ÿè¢«åŒæ­¥
            });
        }

        function startSession() {
            playTone(1000, 0.1, 'sine');
            try {
                saveCurrentUIValues();
                activePool = defaultSubjects.filter(s => s.checked).map(s => ({name: s.name, weight: s.weight}));
                if (activePool.length < 1) { alert("è«‹è‡³å°‘å‹¾é¸ 1 å€‹ç§‘ç›®ï¼"); return; }
                saveSettings();

                const toggle = document.getElementById('deck-mode-toggle');
                isDeckMode = toggle ? toggle.checked : false;

                if (isDeckMode) {
                    currentDeck = JSON.parse(JSON.stringify(activePool));
                    document.getElementById('deck-status').classList.remove('hidden');
                    updateDeckStatus();
                } else {
                    document.getElementById('deck-status').classList.add('hidden');
                }
                switchScreen('draw-screen');
                resetDrawScreen();
            } catch (err) { alert("å•Ÿå‹•å¤±æ•—: " + err.message); }
        }

        function draw() {
            // Androidéœ‡å‹• + iOSè¦–è¦ºéœ‡å‹•
            if (navigator.vibrate) navigator.vibrate(30); 

            let pool = isDeckMode ? currentDeck : activePool;
            if (pool.length === 0) { alert("æ‰€æœ‰ç§‘ç›®éƒ½è®€å®Œäº†ï¼"); return; }

            const resultDisplay = document.getElementById('result-display');
            let counter = 0;
            let shuffle = setInterval(() => {
                resultDisplay.innerText = pool[Math.floor(Math.random() * pool.length)].name;
                playTone(200 + counter*50, 0.03, 'square'); // è·‘é¦¬ç‡ˆéŸ³æ•ˆ
                counter++;
                if(counter > 10) {
                    clearInterval(shuffle);
                    finalizeDraw(pool);
                }
            }, 50);
        }

        function finalizeDraw(pool) {
            const totalWeight = pool.reduce((sum, item) => sum + item.weight, 0);
            let randomNum = Math.random() * totalWeight;
            let selectedIndex = -1, selectedItem = null;

            for (let i = 0; i < pool.length; i++) {
                randomNum -= pool[i].weight;
                if (randomNum < 0) { selectedItem = pool[i]; selectedIndex = i; break; }
            }

            if(selectedItem) {
                showResult(selectedItem, totalWeight);
                recordHistory(selectedItem.name);
                playCheer();       // æ’­æ”¾æ­¡å‘¼
                triggerCelebration(); // æ’­æ”¾å½©å¸¶
            }

            if (isDeckMode) {
                currentDeck.splice(selectedIndex, 1);
                updateDeckStatus();
                if (currentDeck.length === 0) {
                    const btn = document.getElementById('draw-btn');
                    btn.innerText = "å…¨éƒ¨å®Œæˆ";
                    btn.disabled = true;
                    document.getElementById('prob-display').innerText = "æœ¬è¼ªçµæŸ";
                }
            }
        }

        function showResult(item, totalW) {
            const resDisplay = document.getElementById('result-display');
            resDisplay.innerText = item.name;
            const isScience = ['æ•¸å­¸', 'ç‰©ç†', 'åŒ–å­¸', 'ç¨‹å¼'].includes(item.name);
            resDisplay.style.color = isScience ? "#e74c3c" : "#3498db";

            if (!isDeckMode) {
                const prob = ((item.weight / totalW) * 100).toFixed(1);
                document.getElementById('prob-display').innerText = `æ©Ÿç‡: ${prob}%`;
            } else {
                document.getElementById('prob-display').innerText = "å·²é¸å®š";
            }
        }

        // --- ç†±åŠ›åœ–ç³»çµ± ---
        function recordHistory(subjectName) {
            try {
                let history = JSON.parse(localStorage.getItem('study_history') || '[]');
                history.push({ sub: subjectName, time: Date.now() });
                // åªä¿ç•™30å¤©è³‡æ–™ä»¥å…ç†±åŠ›åœ–çˆ†æ‰
                const daysLimit = Date.now() - 30 * 24 * 60 * 60 * 1000;
                history = history.filter(h => h.time > daysLimit);
                localStorage.setItem('study_history', JSON.stringify(history));
            } catch(e) {}
        }

        function showStats() {
            playTone(800, 0.05, 'triangle');
            switchScreen('stats-screen');
            renderHeatmap();
        }

        function renderHeatmap() {
            const grid = document.getElementById('heatmap-grid');
            const headerRow = document.getElementById('date-headers');
            grid.innerHTML = '';
            headerRow.innerHTML = '';

            let history = [];
            try { history = JSON.parse(localStorage.getItem('study_history') || '[]'); } catch(e){}

            // 1. æº–å‚™æ—¥æœŸ (Xè»¸) - éå»6å¤© + ä»Šå¤©
            const dates = [];
            for(let i=6; i>=0; i--) {
                const d = new Date();
                d.setDate(d.getDate() - i);
                const dateStr = `${d.getMonth()+1}/${d.getDate()}`;
                dates.push({ str: dateStr, obj: d });
                
                // æ¸²æŸ“æ¨™é ­
                const th = document.createElement('div');
                th.innerText = dateStr;
                headerRow.appendChild(th);
            }

            // 2. æº–å‚™ç§‘ç›® (Yè»¸) - åªé¡¯ç¤ºæœ‰å‹¾é¸æˆ–æœ‰æ­·å²ç´€éŒ„çš„
            const activeSubNames = defaultSubjects.map(s => s.name); // é¡¯ç¤ºæ‰€æœ‰åˆ—è¡¨ä¸­çš„ç§‘ç›®
            
            // 3. çµ±è¨ˆæ•¸æ“š
            // map: counts[subjectName][dateIndex 0-6] = count
            const dataMap = {};
            activeSubNames.forEach(name => {
                dataMap[name] = [0, 0, 0, 0, 0, 0, 0];
            });

            history.forEach(h => {
                const hDate = new Date(h.time);
                // æª¢æŸ¥é€™ç­†ç´€éŒ„æ˜¯å¦åœ¨æœ€è¿‘7å¤©å…§
                // ç°¡å–®æ¯”å°: è·Ÿ dates é™£åˆ—è£¡çš„æ—¥æœŸæ¯”å°
                const idx = dates.findIndex(d => 
                    d.obj.getDate() === hDate.getDate() && 
                    d.obj.getMonth() === hDate.getMonth()
                );
                if(idx !== -1 && dataMap[h.sub]) {
                    dataMap[h.sub][idx]++;
                }
            });

            // 4. ç¹ªè£½ Grid
            activeSubNames.forEach(subName => {
                // ç§‘ç›®åç¨±æ¬„
                const label = document.createElement('div');
                label.className = 'hm-label-col';
                label.innerText = subName;
                grid.appendChild(label);

                // 7å€‹æ ¼å­çš„æ•¸æ“š
                const counts = dataMap[subName];
                counts.forEach(count => {
                    const cell = document.createElement('div');
                    cell.className = 'hm-cell';
                    
                    // æ±ºå®šé¡è‰²ç­‰ç´š
                    if(count > 0) cell.classList.add('lvl-1');
                    if(count > 1) cell.classList.remove('lvl-1'), cell.classList.add('lvl-2');
                    if(count > 3) cell.classList.remove('lvl-2'), cell.classList.add('lvl-3');
                    if(count > 5) cell.classList.remove('lvl-3'), cell.classList.add('lvl-4');
                    
                    cell.title = `${subName}: ${count}æ¬¡`;
                    grid.appendChild(cell);
                });
            });
        }

        function clearHistory() {
            if(confirm("ç¢ºå®šè¦æ¸…é™¤çµ±è¨ˆç´€éŒ„å—ï¼Ÿ")) {
                localStorage.removeItem('study_history');
                renderHeatmap();
            }
        }

        // --- è¼”åŠ© ---
        function switchScreen(screenId) {
            ['setup-screen', 'draw-screen', 'stats-screen'].forEach(id => {
                const el = document.getElementById(id);
                if(el) el.classList.toggle('hidden', id !== screenId);
            });
        }
        function closeStats() { playTone(800, 0.05, 'triangle'); switchScreen('setup-screen'); }
        function goBack() { 
            stopConfetti(); // é›¢é–‹æ™‚åœæ­¢å½©å¸¶
            playTone(800, 0.05, 'triangle'); 
            switchScreen('setup-screen'); 
        }
        function updateDeckStatus() { document.getElementById('deck-status').innerText = `å‰©é¤˜: ${currentDeck.length}`; }
        function resetDrawScreen() {
            document.getElementById('result-display').innerText = "æº–å‚™";
            document.getElementById('result-display').style.color = "#fff";
            document.getElementById('prob-display').innerText = "é»æ“Šé–‹å§‹";
            const btn = document.getElementById('draw-btn');
            btn.disabled = false;
            btn.innerText = "æŠ½é¸";
        }
        function saveSettings() {
            try {
                const toggle = document.getElementById('deck-mode-toggle');
                const data = { subjects: defaultSubjects, deckMode: toggle ? toggle.checked : false };
                localStorage.setItem('studyApp_data', JSON.stringify(data.subjects));
                localStorage.setItem('studyApp_deckMode', data.deckMode);
            } catch(e) {}
        }
        function loadSettings() {
            const saved = localStorage.getItem('studyApp_data');
            if (saved) {
                const parsed = JSON.parse(saved);
                if(Array.isArray(parsed) && parsed.length > 0) defaultSubjects = parsed;
            }
        }
    </script>
</body>
</html>
